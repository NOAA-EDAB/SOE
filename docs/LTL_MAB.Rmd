---
title: "Environmental and LTL Indicators MAB and Shelf-wide"
output:
  rmarkdown::html_document:
    toc: true
    toc_float: true
    theme: lumen
  rmarkdown::word_document:
    toc: true
---

```{r setup, include=FALSE}
image.dir<- here::here("docs/images")
#Default Rmd options
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      fig.align = 'center') #allows for inserting R code into captions

#Plotting and data libraries
library(ggplot2)
library(dplyr)
library(tidyr)
library(ecodata)
library(here)
library(kableExtra)
library(ggrepel)
library(stringr)
library(patchwork)
library(grid)
library(heatwaveR)
library(stringr)

#General inline text input for report

#Council
council <- "Mid-Atlantic Fishery Management Council"
council_abbr <- "MAFMC"

#Region identifiers
epu <- "Mid-Atlantic Bight"
epu_abbr <- "MAB"
region <- "Mid-Atlantic"
region_abbr <- "MA" #Some commercial data organized by "MA" or "NE" regions, not by EPU 

############################# GIS SETUP ######################################################

#GIS libraries
library(sf)
library(rgdal)
library(raster)
#CRS
crs <- "+proj=longlat +lat_1=35 +lat_2=45 +lat_0=40 +lon_0=-77 +x_0=0 +y_0=0 +datum=NAD83 +no_defs +ellps=GRS80 +towgs84=0,0,0"

#EPU shapefile
epu_sf <- ecodata::epu_sf %>% 
  filter(EPU %in% c("MAB","GB","GOM"))

#Map line parameters
map.lwd <- 0.4

# Set lat/lon window for maps
xmin = -77
xmax = -65
ymin = 36
ymax = 45
xlims <- c(xmin, xmax)
ylims <- c(ymin, ymax)

#Time series constants
shade.alpha <- 0.3
shade.fill <- "lightgrey"
lwd <- 1
pcex <- 2
trend.alpha <- 0.5
trend.size <- 2
hline.size <- 1
hline.alpha <- 0.35
hline.lty <- "dashed"
label.size <- 5
hjust.label <- 1.5
letter_size <- 4
feeding.guilds <- c("Apex Predator","Piscivore","Planktivore","Benthivore","Benthos")
x.shade.min <- 2010
x.shade.max <- 2020
#Function for custom ggplot facet labels
label <- function(variable,value){
  return(facet_names[value])
}

```


Trend lines are shown when slope is significantly different from 0 at the p < 0.05 level. An orange line signifies an overall positive trend, and purple signifies a negative trend. Note that in the final report we will only test for trend when N >= 30. However, I have relaxed that requirement for the purposes of this document so that trends are highlighted when N >= 20. **This means that some trends shown here will not be present in the final document**. Dashed lines represent mean values of time series unless the indicator is an anomaly, in which case the dashed line is equal to 0. Shaded regions indicate the past ten years. If there are no new data for 2018, the shaded region will still cover this time period.

## Mid-Atlantic Bight

### Ocean Temperature {.tabset .tabset-fade}

#### SST

```{r seasonal-sst-anom-gridded, fig.cap="MAB seasonal sea surface temperature time series overlaid onto 2020 seasonal spatial anomalies."}
annotation_custom2 <- function (grob, xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf, data) 
{
  layer(data = data, stat = StatIdentity, position = PositionIdentity, 
        geom = ggplot2:::GeomCustomAnn,
        inherit.aes = TRUE, params = list(grob = grob, 
                                          xmin = xmin, xmax = xmax, 
                                          ymin = ymin, ymax = ymax))
}

#EPU shapefile
mab_epu_sf <- ecodata::epu_sf %>% 
  dplyr::filter(EPU %in% c("MAB")) 

#Map line parameters
map.lwd <- 0.4

# Set lat/lon window for maps
xmin = -81
xmax = -66
ymin = 35.5
ymax = 43
xlims <- c(xmin, xmax)
ylims <- c(ymin, ymax)
sst <- ecodata::seasonal_sst_anomaly_gridded 

sst$Season <- factor(sst$Season, levels = c("Winter",
                                            "Spring",
                                            "Summer",
                                            "Fall"))
sst<- sst %>% dplyr::mutate(Value = replace(Value, Value > 4, 4))
sst_map <- 
  ggplot2::ggplot() +
  ggplot2::geom_tile(data = sst, aes(x = Longitude, y = Latitude,fill = Value)) +
  ggplot2::geom_sf(data = ecodata::coast, size = map.lwd) +
  ggplot2::geom_sf(data = mab_epu_sf, fill = "transparent", size = map.lwd) +
  ggplot2::scale_fill_gradient2(name = "Temp.\nAnomaly (C)",
                       low = scales::muted("blue"),
                       mid = "white",
                       high = scales::muted("red"),
                       limits = c(-4,4),
                       labels = c("<-4", "-2", "0", "2", ">4")) +
  ggplot2::coord_sf(crs = crs, xlim = xlims, ylim = ylims) +
  ggplot2::facet_wrap(Season~.) +
  ecodata::theme_map() +
  ggplot2::ggtitle("SST anomaly (2020)") +
  ggplot2::xlab("Longitude") +
  ggplot2::ylab("Latitude") +
  ggplot2::theme(panel.border = element_rect(colour = "black", fill=NA, size=0.75),
        legend.key = element_blank(),
        axis.title = element_text(size = 11),
        strip.background = element_blank(),
        strip.text=element_text(hjust=0),
        axis.text = element_text(size = 8), 
        axis.title.y = element_text(angle = 90))

winter_anom <-  ggplot2::ggplotGrob( seasonal_oisst_anom %>% 
                              dplyr::filter(EPU == "MAB",
                                     stringr::str_detect(Var, "winter")) %>% 
                              dplyr::mutate(hline = mean(Value)) %>% 
                              ggplot2::ggplot(aes(x = Time, y = Value)) +
                              ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
                                       xmin = x.shade.min , xmax = x.shade.max,
                                       ymin = -Inf, ymax = Inf) +
                              ggplot2::geom_line() +
                              ggplot2::geom_point() +
                              ecodata::geom_gls(alpha = trend.alpha + 0.25) +
                              ggplot2::ylab("SST anomaly (C)")+
                              ggplot2::xlab(element_blank())+
                              ggplot2::scale_x_continuous(expand = c(0.01, 0.01)) +
                              ggplot2::geom_hline(aes(yintercept = hline)) +
                              ecodata::theme_ts()+
                              ggplot2::theme(axis.title = element_text(size = 6),
                                    axis.text = element_text(size = 6),
                                    panel.background = element_rect(fill = "transparent"), 
                                    plot.background = element_rect(fill = "transparent", color = NA), 
                                    panel.grid.major = element_blank(),
                                    panel.grid.minor = element_blank(), 
                                    legend.background = element_rect(fill = "transparent"), 
                                    legend.box.background = element_rect(fill = "transparent"), 
                                    legend.key = element_rect(fill = "transparent", colour = NA), 
                                    axis.line = element_blank(),
                                    panel.border = element_blank())
)

spring_anom <-  ggplot2::ggplotGrob( seasonal_oisst_anom %>% 
                              dplyr::filter(EPU == "MAB",
                                     stringr::str_detect(Var, "spring")) %>% 
                              dplyr::mutate(hline = mean(Value)) %>% 
                              ggplot2::ggplot(aes(x = Time, y = Value)) +
                              ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
                                       xmin = x.shade.min , xmax = x.shade.max,
                                       ymin = -Inf, ymax = Inf) +
                              ggplot2::geom_line() +
                              ggplot2::geom_point() +
                              ecodata::geom_gls(alpha = trend.alpha + 0.25) +
                              ggplot2::ylab("SST anomaly (C)")+
                              ggplot2::xlab(element_blank())+
                              ggplot2::scale_x_continuous(expand = c(0.01, 0.01)) +
                              ggplot2::geom_hline(aes(yintercept = hline)) +
                              ecodata::theme_ts()+
                              ggplot2::theme(axis.title = element_text(size = 6),
                                    axis.text = element_text(size = 6),
                                    panel.background = element_rect(fill = "transparent"), 
                                    plot.background = element_rect(fill = "transparent", color = NA),
                                    panel.grid.major = element_blank(),
                                    panel.grid.minor = element_blank(), 
                                    legend.background = element_rect(fill = "transparent"), 
                                    legend.box.background = element_rect(fill = "transparent"), 
                                    legend.key = element_rect(fill = "transparent", colour = NA), 
                                    axis.line = element_blank(),
                                    panel.border = element_blank())
)

summer_anom <-  ggplot2::ggplotGrob( seasonal_oisst_anom %>% 
                              dplyr::filter(EPU == "MAB",
                                     stringr::str_detect(Var, "summer")) %>% 
                              dplyr::mutate(hline = mean(Value)) %>% 
                              ggplot2::ggplot(aes(x = Time, y = Value)) +
                              ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
                                       xmin = x.shade.min , xmax = x.shade.max,
                                       ymin = -Inf, ymax = Inf) +
                              ggplot2::geom_line() +
                              ggplot2::geom_point() +
                              ecodata::geom_gls(alpha = trend.alpha + 0.25) +
                              ggplot2::ylab("SST anomaly (C)")+
                              ggplot2::xlab(element_blank())+
                              ggplot2::scale_x_continuous(expand = c(0.01, 0.01)) +
                              ggplot2::geom_hline(aes(yintercept = hline)) +
                              ecodata::theme_ts()+
                              ggplot2::theme(axis.title = element_text(size = 6),
                                    axis.text = element_text(size = 6),
                                    panel.background = element_rect(fill = "transparent"),
                                    plot.background = element_rect(fill = "transparent", color = NA),
                                    panel.grid.major = element_blank(), 
                                    panel.grid.minor = element_blank(), 
                                    legend.background = element_rect(fill = "transparent"),
                                    legend.box.background = element_rect(fill = "transparent"), 
                                    legend.key = element_rect(fill = "transparent", colour = NA), 
                                    axis.line = element_blank(),
                                    panel.border = element_blank())
)

fall_anom <-  ggplot2::ggplotGrob( seasonal_oisst_anom %>% 
                            dplyr::filter(EPU == "MAB",
                                   stringr::str_detect(Var, "fall")) %>% 
                            dplyr::mutate(hline = mean(Value)) %>% 
                            ggplot2::ggplot(aes(x = Time, y = Value)) +
                            ggplot2::geom_line() +
                            ggplot2::geom_point() +
                            ecodata::geom_gls(alpha = trend.alpha + 0.25) +
                            ggplot2::ylab("SST anomaly (C)")+
                            ggplot2::xlab(element_blank())+
                            ggplot2::scale_x_continuous(expand = c(0.01, 0.01)) +
                            ggplot2::geom_hline(aes(yintercept = hline)) +
                            ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
                                     xmin = x.shade.min , xmax = x.shade.max,
                                     ymin = -Inf, ymax = Inf) +
                            ecodata::theme_ts()+
                            ggplot2::theme(axis.title = element_text(size = 6),
                                  axis.text = element_text(size = 6),
                                  panel.background = element_rect(fill = "transparent"), 
                                  plot.background = element_rect(fill = "transparent", color = NA), 
                                  panel.grid.major = element_blank(), 
                                  panel.grid.minor = element_blank(), 
                                  legend.background = element_rect(fill = "transparent"), 
                                  legend.box.background = element_rect(fill = "transparent"),
                                  legend.key = element_rect(fill = "transparent", colour = NA),
                                  axis.line = element_blank(),
                                  panel.border = element_blank())
)

sst_map + 
  annotation_custom2(grob = winter_anom,  xmin=-82, xmax=-73.75,
                     ymin=39, ymax=43.5, data = data.frame(Season = "Winter")) +
  annotation_custom2(grob = spring_anom,  xmin=-82, xmax=-73.75,
                     ymin=39, ymax=43.5, data = data.frame(Season = "Spring")) +
  annotation_custom2(grob = summer_anom,  xmin=-82, xmax=-73.75,
                     ymin=39, ymax=43.5, data = data.frame(Season = "Summer")) +
  annotation_custom2(grob = fall_anom,  xmin=-82, xmax=-73.75,
                     ymin=39, ymax=43.5, data = data.frame(Season = "Fall"))

```


#### Bottom temperature

```{r bottom-temp, fig.width = 6, fig.asp = .55, fig.cap="Annual bottom temperature in the Mid-Atlantic Bight. (black = Paula's, red = GLORYS)"}
temp_anom <- ecodata::bottom_temp %>% 
  dplyr::filter(EPU == epu_abbr) %>% 
  tidyr::complete(Time = tidyr::full_seq(min(bottom_temp$Time):max(bottom_temp$Time),1),
           tidyr::nesting(Var)) %>% 
  dplyr::mutate(hline = 0)%>%
 dplyr::filter(Var == "bottom temp anomaly in situ")

gl_bt<- ecodata::bottom_temp_glorys%>% 
  dplyr::filter(EPU == epu_abbr)
#bot_temp<-temp_anom %>%
# dplyr::filter(Var == "bottom temp anomaly in situ") %>%
ggplot2::ggplot() +
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  ggplot2::geom_line(aes(x = temp_anom$Time, y = temp_anom$Value), color = "black") +
  ggplot2::geom_point(aes(x = temp_anom$Time, y = temp_anom$Value), size = 1, color = "black") +
  ggplot2::geom_point(aes(x = gl_bt$Time, y = gl_bt$Value), size = 1, color = "red") +
  ggplot2::geom_line(aes(x = gl_bt$Time, y = gl_bt$Value), color = "red") +
  ecodata::geom_gls(aes(x = temp_anom$Time, y = temp_anom$Value)) +
  ggplot2::ylab("Temperature (C)") +
  ggplot2::xlab(element_blank())+
  ggplot2::ggtitle("Bottom temperature anomaly") +
  ggplot2::scale_x_continuous(expand = c(0.01, 0.01)) +
  ggplot2::theme(strip.text=element_text(hjust=0),
        plot.title = element_text(size = 12))+
  #ggplot2::geom_hline(aes(yintercept = hline),
  #         size = hline.size,
  #         alpha = hline.alpha,
  #         linetype = hline.lty) +
  ecodata::theme_ts()

```



<!-- ```{r bottom-temp-glorys, fig.width = 6, fig.asp = .55, fig.cap="Annual bottom temperature in the Mid-Atlantic Bight."} -->
<!-- ecodata::bottom_temp_glorys %>%  -->
<!--   dplyr::filter(EPU == epu_abbr)%>% -->
<!--   dplyr::group_by(EPU) %>%  -->
<!--   dplyr::mutate(hline = mean(Value)) %>%  -->
<!-- ggplot2::ggplot() + -->
<!--   ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha, -->
<!--       xmin = x.shade.min , xmax = x.shade.max, -->
<!--       ymin = -Inf, ymax = Inf) + -->
<!--   ggplot2::geom_line(aes(x = Time, y = Value)) + -->
<!--   #ecodata::geom_gls(aes(x = Time, y = Value)) + -->
<!--   ggplot2::geom_point(aes(x = Time, y = Value), size = 1) + -->
<!--   ggplot2::ylab("Temperature (C)") + -->
<!--   ggplot2::xlab(element_blank())+ -->
<!--   ggplot2::ggtitle("Bottom temperature GLORYS anomaly") + -->
<!--   ggplot2::scale_x_continuous(expand = c(0.01, 0.01)) + -->
<!--   ggplot2::theme(strip.text=element_text(hjust=0), -->
<!--         plot.title = element_text(size = 12))+ -->
<!--   ggplot2::geom_hline(aes(yintercept = hline), -->
<!--            size = hline.size, -->
<!--            alpha = hline.alpha, -->
<!--            linetype = hline.lty) + -->
<!--   ecodata::theme_ts() -->

<!-- ``` -->


### Chlorophyll and Primary Productivity {.tabset .tabset-fade}


#### Primary production


```{r pp-monthly, fig.width=8, fig.cap="Monthly primary production trends show the annual cycle (i.e. the peak during the summer months) and the changes over time for each month."}
out_pp <- ecodata::chl_pp %>% 
  dplyr::filter(EPU == epu_abbr,
         stringr::str_detect(Var, "MONTHLY_PPD_MEDIAN")) %>% 
  tidyr::separate(.,Time, into = c("Cat", "Time2"), sep = "_") %>% 
  tidyr::separate(.,Time2, into = c("Year", "Month"), sep = 4) %>% 
  dplyr::mutate(Month = plyr::mapvalues(Month, from = c("01","02","03","04","05","06",
                                                   "07","08","09","10","11","12"),
                                   to = c(month.abb))) %>% 
  dplyr::filter(!Value == "NA") %>% 
  dplyr::group_by(Month) %>% 
  dplyr::mutate(hline = mean(Value))

out_pp$Month <- factor(out_pp$Month, levels = month.abb)


pp_cci <- ggplot2::ggplot(out_pp) +
   # geom_gls(aes(x = Year, y = Value, group = Month))+
    ggplot2::geom_point(aes(x = Year, y = Value, group = Month)) +
    ggplot2::geom_line(aes(x = Year, y = Value, group = Month)) +
    ggplot2::scale_x_discrete(name = "", breaks = seq(min(out_pp$Year),max(out_pp$Year),10)) +  
    ggplot2::geom_hline(aes(yintercept = hline),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
    ggplot2::facet_wrap(Month~., ncol = 12) +
    ggplot2::ggtitle("Monthly median PPD") +
    ggplot2::ylab(expression("PP (gC m"^-2*" d"^-1*")")) +
    ecodata::theme_facet() +
    ggplot2::theme(axis.text.x = element_text(angle=45, hjust = 1),
          panel.spacing = unit(0.5, "lines"),
          plot.margin = unit(c(0.1, 0, 0, 0), "cm"))
pp_cci
```


```{r chl-monthly, eval = T}
out_chl <- ecodata::chl_pp %>% 
  dplyr::filter(EPU == epu_abbr,
         stringr::str_detect(Var, "MONTHLY_CHLOR_A_MEDIAN")) %>% 
  tidyr::separate(.,Time, into = c("Cat", "Time2"), sep = "_") %>% 
  tidyr::separate(.,Time2, into = c("Year", "Month"), sep = 4)%>% 
    dplyr::mutate(Month = plyr::mapvalues(Month, from = c("01","02","03","04","05","06",
                                                   "07","08","09","10","11","12"),
                                   to = c(month.abb)))%>% 
  dplyr::filter(!Value == "NA") %>% 
  dplyr::group_by(Month) %>% 
  dplyr::mutate(hline = mean(Value))

out_chl$Month <- factor(out_chl$Month, levels = month.abb)


chl_cci <- ggplot2::ggplot(out_chl) +
   # geom_gls(aes(x = Year, y = Value, group = Month))+
    ggplot2::geom_point(aes(x = Year, y = Value, group = Month)) +
    ggplot2::geom_line(aes(x = Year, y = Value, group = Month)) +
    ggplot2::scale_x_discrete(name = "", breaks = seq(min(out_chl$Year),max(out_chl$Year),10)) +  
            geom_hline(aes(yintercept = hline),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
    ggplot2::facet_wrap(Month~., ncol = 12) +
    ggplot2::ggtitle("Monthly median CHL") +
    ggplot2::ylab(expression("CHL (mg m"^-3*")")) +
    ecodata::theme_facet() +
    ggplot2::theme(axis.text.x = element_text(angle=45, hjust = 1),
          panel.spacing = unit(.5, "lines"),
          plot.margin = unit(c(0.1, 0, 0, 0), "cm"))

chl_cci
```


#### Sesonal chlorophyll *a* & primary production

```{r chl-weekly,fig.cap = "Weekly chlorophyll concentrations and primary productivity in the Mid-Atlantic are shown for by the colored line for 2020. The long-term mean is shown in black and shading indicates +/- 1 sample SD."}

interp_chl_pp <- function(epu, year = 2020, Variable){
  out <- ecodata::chl_pp %>% 
    dplyr::filter(stringr::str_detect(Var,Variable),
           EPU == epu) %>% 
    tidyr::separate(.,Time, into = c("Cat", "Time2"), sep = "_") %>% 
    tidyr::separate(.,Time2, into = c("Year", "Week"), sep = 4) %>% 
    dplyr::filter(Year == year) %>% 
    dplyr::group_by(EPU) %>% 
    dplyr::mutate(Time = 1:length(Year))
  
  ltm_out <- ecodata::chl_pp %>% 
    dplyr::filter(stringr::str_detect(Var,Variable),
           EPU == epu) %>% 
    tidyr::separate(.,Time, into = c("Cat", "Time2"), sep = "_") %>% 
    tidyr::separate(.,Time2, into = c("Year", "Week"), sep = 4)  %>% 
    dplyr::group_by(Week) %>% 
    dplyr::summarise(LTM = mean(Value, na.rm = T),
                     SD = sd(Value, na.rm = T)) %>% 
    dplyr::mutate(Time = 1:length(Week),
           sd.low = LTM - SD,
           sd.high = LTM + SD) %>% 
    dplyr::left_join(.,out, by = c("Time")) %>% 
    dplyr::mutate(status = ifelse(Value < sd.high & Value > sd.low, "near_mean",
                           ifelse(Value > sd.high, "high",
                                  ifelse(Value < sd.low,"low",NA))),
           group = "PLOT")
  
  return(ltm_out)
}

MAB_chl <- interp_chl_pp(epu = "MAB", Variable = "WEEKLY_CHLOR_A_MEDIAN")
MAB_early<- MAB_chl %>% filter(Week.x <=26)
MAB_late <- MAB_chl %>% filter(Week.x >=26)

MAB_chl_weekly <- ggplot2::ggplot(data = MAB_early) +
  ggplot2::geom_line(aes(x = Time, y = LTM)) +
  ggplot2::geom_ribbon(aes(x = Time, ymin = sd.low, ymax = sd.high), 
              alpha = 0.1,
              fill = "grey1") +
  ggplot2::geom_line(data = MAB_late,aes(x = Time, y = LTM)) +
  ggplot2::geom_ribbon(data = MAB_late,aes(x = Time, ymin = sd.low, ymax = sd.high), 
              alpha = 0.1,
              fill = "grey1")+
  ggplot2::geom_line(aes(x = Time, y = Value),
            size = 1,color = "#33a02c") +
    ggplot2::geom_line(data = MAB_late, aes(x = Time, y = Value),
            size = 1,color = "#33a02c", linetype = "dashed")+
  ggplot2::ggtitle(expression("Chlorophyll"~italic(a)~"")) +
  ggplot2::guides(color = F) +
  ggplot2::xlab("")+
  ggplot2::ylab(expression("CHL (mg m"^-3*")")) +
  ggplot2::scale_x_continuous(breaks = seq(1,52,10),
                   labels = c("Jan.","Mar.","May","July","Oct.","Dec."),
                   expand = c(0.01,0.01)) +
  ggplot2::scale_color_manual(values = c("#ef8a62","#2c7fb8","#a1d99b"))+
  ecodata::theme_ts()

MAB_pp <- interp_chl_pp(epu = "MAB", Variable =  "WEEKLY_PPD_MEDIAN")
MAB_early<- MAB_pp %>% filter(Week.x <=26)
MAB_late <- MAB_pp %>% filter(Week.x >=26)

MAB_pp_weekly <- ggplot2::ggplot(data = MAB_early) +
  ggplot2::geom_line(aes(x = Time, y = LTM)) +
  ggplot2::geom_ribbon(aes(x = Time, ymin = sd.low, ymax = sd.high),
              alpha = 0.1,
              fill = "grey1") +
  ggplot2::geom_line(data = MAB_late,aes(x = Time, y = LTM)) +
  ggplot2::geom_ribbon(data = MAB_late,aes(x = Time, ymin = sd.low, ymax = sd.high), 
              alpha = 0.1,
              fill = "grey1")+
  ggplot2::geom_line(aes(x = Time, y = Value),
            size = 1,color = "#33a02c") +
  ggplot2::geom_line(data = MAB_late, aes(x = Time, y = Value),
            size = 1,color = "#33a02c", linetype = "dashed")+
  ggplot2::ggtitle(expression("Primary production")) +
  ggplot2::guides(color = F) +
  ggplot2::xlab("")+
  ggplot2::ylab(expression("PP (gC m"^-2*" d"^-1*")")) +
  ggplot2::scale_x_continuous(breaks = seq(1,52,10),
                   labels = c("Jan.","Mar.","May","July","Oct.","Dec."),
                   expand = c(0.01,0.01)) +
  ggplot2::scale_color_manual(values = c("#ef8a62","#2c7fb8","#a1d99b"))+
  ecodata::theme_ts()

MAB_chl_weekly + MAB_pp_weekly + plot_layout(ncol = 1)

```

#### Phytoplankton Size Class

```{r weekly-phyto-size, eval = T}


chlor <- ecodata::phyto_size %>% 
  dplyr::filter(EPU == c( "MAB"),
                !Value == "NA", 
                Var == "CLIMATOLOGICAL_WEEK_CHLOR_A_MEDIAN")  %>% 
  tidyr::separate(.,Time, into = c("Cat", "WEEK", "Year1", "Year2"), sep = "_") %>% 
  mutate(Value = Value/2)

month <- seq(as.Date("2020-01-01"), 
             as.Date("2020-12-01"), 
             by = "1 month")
month_numeric <- lubridate::yday(month) / 365 * 52 + 1
month_label <- lubridate::month(month, label = TRUE)

out_phyto2<-  ecodata::phyto_size %>% 
  dplyr::filter(EPU == c("MAB"),
         stringr::str_detect(Var, ("CLIMATOLOGICAL_WEEK"))) %>% 
  tidyr::separate(.,Time, into = c("Cat", "WEEK", "Year1", "Year2"), sep = "_") %>% 
  dplyr::filter(!Value == "NA", 
                !Var == "CLIMATOLOGICAL_WEEK_CHLOR_A_MEDIAN")  %>%

  ggplot2::ggplot() +
   geom_area(aes(x=as.numeric(WEEK), y=Value, 
                 fill = factor(Var, c("CLIMATOLOGICAL_WEEK_PICO_PERCENTAGE_MEDIAN",
                                      "CLIMATOLOGICAL_WEEK_NANO_PERCENTAGE_MEDIAN", 
                                      "CLIMATOLOGICAL_WEEK_MICRO_PERCENTAGE_MEDIAN"))), alpha=0.6)+
    #ggplot2::geom_point(data = chlor, aes(x = as.numeric(WEEK), y = Value)) +
    #ggplot2::geom_line(data = chlor, aes(x = as.numeric(WEEK), y = Value))+
    #ggplot2::facet_wrap(EPU~., ncol = 2)+
    ggplot2::ggtitle("Mid-Atlantic Bight Phytoplankton Size Class") +
    ggplot2::ylab("Percent") +
    ggplot2::xlab(element_blank())+
    ecodata::theme_facet() +
    ggplot2::theme(axis.text.x = element_text(angle=45, hjust = 1),
          panel.spacing = unit(.5, "lines"),
          plot.margin = unit(c(0.1, 0, 0, 0), "cm"), 
          legend.position= "top")+
    scale_fill_manual(values=c("#8DA0CB", "#FC8D62",  "#66C2A5"), name = "", 
                     labels = c("Picoplankton", 
                                "Nanoplankton", "Microplankton"))+
    #scale_y_continuous( name = "Phytoplankton Size Fraction", sec.axis = sec_axis(~.*2, name="Chlorophyll a (mg m^-3)"))+
   scale_x_continuous(breaks = month_numeric, 
                    labels = month_label)

out_phyto2

```

```{r}

micro_chlor <- ecodata::phyto_size %>% 
  dplyr::filter(EPU %in% c("MAB"),
                Var %in% c("CLIMATOLOGICAL_WEEK_MICRO_PERCENTAGE_MEDIAN", 
                           "CLIMATOLOGICAL_WEEK_CHLOR_A_MEDIAN")) %>% 
  tidyr::separate(.,Time, into = c("Cat", "WEEK", "Year1", "Year2"), sep = "_") %>% 
  dplyr::filter(!Value == "NA") %>% 
  dplyr::select(-Year1, -Year2, -Cat,  -Units) %>% 
  tidyr::pivot_wider(id_cols= c(EPU, WEEK), names_from = Var, values_from = Value) %>% 
  dplyr::mutate(Month = rep(1:4, each = 13)) %>% 
  ggplot2::ggplot() +
  ggplot2::geom_point( aes(x = CLIMATOLOGICAL_WEEK_MICRO_PERCENTAGE_MEDIAN, 
                           y = CLIMATOLOGICAL_WEEK_CHLOR_A_MEDIAN, color = factor(Month))) +
   ggplot2::scale_color_discrete(name = "Season", labels=c("Jan-Mar", "Apr-Jun", "Jul-Sep", "Oct-Dec"))+
  ggplot2::ggtitle("MAB ") +
  #ggplot2::facet_wrap(~EPU)+
  ggplot2::ylab("Chlorophyll a (mg m^-3)") +
  ggplot2::xlab("Microplankton % of Total Phytoplankton Composition ") +
  ecodata::theme_facet()#+
  #ggplot2::theme(legend.title = element_text("Season"), 
  #               legend.text =element_text("Jan-Mar", "Apr-Jun", "Jul-Sep", "Oct-Dec") )#+
 
micro_chlor

```

### Chesapeake Bay Water Quality Attainment
 
<span style="color: red;">NO NEW DATA</span>

<!-- <p style="color:red">No data delivered. Note from Jan 2 -  We are in the process of finalizing our assessment of Chesapeake bay water quality standards attainment for the latest assessment cycle (2016-2018). We may send you the data in a week or two.</p> -->

```{r ches-bay-wq,fig.width = 6, fig.asp = 0.55, fig.cap = "Water quality attainment in Chesapeake Bay following rolling three year assessment periods."}

minlab <- seq(1985,2015,5)
maxlab <- seq(1987,2017,5)



ecodata::ches_bay_wq %>% 
  dplyr::mutate(hline = mean(Value)) %>% 
  ggplot2::ggplot(aes(x = Time, y = Value)) +
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  ggplot2::geom_line() +
  ggplot2::geom_point() +
  ecodata::geom_gls() +
  ggplot2::ylab(expression("Estimated attainment, percent")) +
  ggplot2::xlab(element_blank())+
  ggplot2::ggtitle("Chesapeake Bay Water Quality Attainment") +
  ggplot2::scale_x_continuous(breaks = minlab,labels = paste0(minlab,"-",maxlab),expand = c(0.01, 0.01)) +
  ggplot2::geom_hline(aes(yintercept = hline),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
  ecodata::theme_ts()
```

### Chesapeake Bay 

<span style="color: red;">NO NEW DATA, only summary</span>

Headline:  Warmer-than-average winter water temps in Chesapeake Bay likely help blue crabs, hurt striped bass numbers.

[Details here](https://docs.google.com/document/u/1/d/12Aq9nxrdrtZKESoZ8KtW152i0amf_O54/edit?usp=drive_web&ouid=111390006230717850267&rtpof=true).


<!-- ### Chesepeake Bay Salinity Anomolies -->



<!-- Write up on anomalies in salinity we saw in 2018,2019 following record breaking rain in 2018.  The low salinities impacted [hypoxia, fish and oysters](https://docs.google.com/document/d/19ikLWKQWiRSrjmQJ2F7EB_ZcieBMk6Ykf1RX_Gissao/edit).  -->

<!-- ```{r ch-bay-sal, fig.cap = "Salinity in Chesapeake Bay throughout 2018 (blue) and 2019 (red)  as well as the daily average 2008-2019 (black). "} -->

<!-- ches_sal<-ecodata::ch_bay_sal %>%  -->
<!--   dplyr::filter(!Var == "UTCTime") %>%  -->
<!--   tidyr::drop_na() %>% -->
<!--   dplyr::mutate(Time =  as.numeric(str_sub(Time, 2, -1)), -->
<!--          Time1 = as.Date(Time, origin = "2018-12-31")) %>%  -->
<!--   tidyr::pivot_wider(names_from = Var, values_from = Value) -->

<!-- ches_sal %>%  -->
<!--   ggplot2::ggplot() + -->
<!--   ggplot2::geom_ribbon(aes(x = Time1, ymin = AvgMinLim, ymax = AvgMaxLim))+ -->
<!--   ggplot2::geom_ribbon(aes(x = Time1, ymin = MinDataLim, ymax = MaxDataLim), alpha = 0.3)+ -->
<!--   ggplot2::geom_line(aes(x = Time1, y = Daily18), color = "blue") + -->
<!--   ggplot2::geom_line(aes(x = Time1, y = Daily19), color = "red") + -->
<!--   ggplot2::ylab(expression("PSU")) + -->
<!--   ggplot2::ggtitle("Chesapeake Bay Salinity") + -->
<!--   ecodata::theme_ts() -->
<!-- ``` -->

### Zooplankton {.tabset .tabset-fade}


#### Euphausiids + Cnidarians

```{r zoo-strat-abun, fig.cap="Stratified abundance of cnidarians and euphausiids in Mid-Atlantic Bight."}
zoo_abund <- ecodata::zoo_strat_abun %>% 
  dplyr::filter(EPU == epu_abbr,
         !stringr::str_detect(Var, "Small|Large")) %>% 
  dplyr::mutate(Value = log10(Value+1)) %>% 
  dplyr::group_by(Var, EPU) %>% 
  dplyr::mutate(hline = mean(Value)) 

zoo_abund %>% 
  ggplot2::ggplot(aes(x = Time, y = Value)) +
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  ecodata::geom_gls() +
  ggplot2::geom_line() +
  ggplot2::geom_point() +
  ggplot2::ylab(expression("Log Stratified Abundance")) +
  ggplot2::xlab(element_blank())+
  ggplot2::ggtitle("Zooplankton abundance") +
  ggplot2::facet_wrap(Var~., ncol = 3) +
  ggplot2::scale_x_continuous(expand = c(0.01, 0.01))+
  ggplot2::geom_hline(aes(yintercept = hline),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty)+
  ecodata::theme_facet() +
  ggplot2::theme(strip.text=element_text(hjust=0,
                                face = "italic"))
  

```


<!--#### Small and Large Calanoid stratified abundance -->

<!-- ```{r MAB-sm-lg, fig.cap= "Large (red) and small (black) copepod zooplankton abundance in the Mid-Atlantic Bight."} -->
<!-- zoo_abund <- ecodata::zoo_strat_abun %>%  -->
<!--   filter(EPU == epu_abbr, -->
<!--          str_detect(Var, "Small|Large")) %>%  -->
<!--   mutate(Value = Value/10^8) %>%  -->
<!--   group_by(Var, EPU) %>%  -->
<!--   mutate(hline = mean(Value))  -->

<!-- zoo_abund %>%  -->
<!--   ggplot() + -->
<!--   annotate("rect", fill = shade.fill, alpha = shade.alpha, -->
<!--       xmin = x.shade.min , xmax = x.shade.max, -->
<!--       ymin = -Inf, ymax = Inf) + -->
<!--   geom_line(aes(x = Time, y = Value, color = Var)) + -->
<!--   geom_point(aes(x = Time, y = Value, color = Var)) + -->
<!--   geom_gls(aes(x = Time, y = Value, group = Var)) + -->
<!--   scale_color_manual(values = c("#ca0020", "black"))+ -->
<!--   ylab(expression("Stratified Abundance" (10^"8"))) + -->
<!--   xlab(element_blank())+ -->
<!--   ggtitle("Small and large copepod abundance") + -->
<!--   scale_x_continuous(expand = c(0.01, 0.01))+ -->
<!--   geom_hline(aes(yintercept = hline, -->
<!--            color = Var),  -->
<!--            size = hline.size, -->
<!--            alpha = hline.alpha, -->
<!--            linetype = hline.lty)+ -->
<!--   theme_facet() + -->
<!--   theme(strip.text=element_text(hjust=0, -->
<!--                                 face = "italic"), -->
<!--         legend.position = "none") -->


<!-- ``` -->


#### Abundance anomaly

```{r zoo-abund,  fig.cap= "Large (red) and small-bodied (blue) copepod abundance in the Mid-Atlantic Bight." }
ecodata::zoo_sli_anom %>%
   dplyr::filter(EPU == epu_abbr) %>%
   dplyr::group_by(Time) %>% 
   dplyr::mutate(hline = 0) %>% 
   ggplot2::ggplot(aes(x = Time, y = Value, color = Var)) +
   ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
       xmin = x.shade.min , xmax = x.shade.max,
       ymin = -Inf, ymax = Inf) +
   #geom_gls() +
   ggplot2::geom_line() +
   ggplot2::geom_point() +
   ggplot2::ylab("Abundance anomaly") +
   ggplot2::xlab(element_blank())+
   ggplot2::ggtitle("Small and large-bodied copepod abundance anomaly") +
   ggplot2::scale_x_continuous(expand = c(0.01, 0.01))+
   ggplot2::geom_hline(aes(yintercept = hline),
            size = hline.size,
            alpha = hline.alpha,
            linetype = hline.lty)+
   ecodata::theme_ts()+
   ggplot2::theme(strip.text=element_text(hjust=0,
                                 face = "italic"), 
         legend.title = element_blank())


```

<!-- #### Small-large index -->

<!-- ```{r MAB-sli} -->
<!-- sli <- ecodata::zoo_sli_anom %>%  -->
<!--   filter(EPU == epu_abbr, -->
<!--          str_detect(Var, "Sm-Lg copepod anom")) %>%  -->
<!--   mutate(hline = 0)  -->

<!-- pp_anom <- ecodata::chl_pp %>%  -->
<!--   filter(str_detect(Var, "ANNUAL_PPD_RATIO_ANOMALY"), -->
<!--          EPU == "MAB") %>%  -->
<!--   mutate(hline = 1, -->
<!--          Time = as.numeric(as.character(Time)), -->
<!--          Var = "ANNUAL_PPD_RATIO_ANOMALY") -->

<!-- sli_plt <- sli %>%  -->
<!--   ggplot(aes(x = Time, y = Value, group = Var)) + -->
<!--          annotate("rect", fill = shade.fill, alpha = shade.alpha, -->
<!--       xmin = x.shade.min , xmax = x.shade.max, -->
<!--       ymin = -Inf, ymax = Inf) + -->
<!--   geom_line() + -->
<!--   geom_point() + -->
<!--   guides(color = F) + -->
<!--   xlab("")+ -->
<!--   ylab("Small-large abundance") + -->
<!--   ggtitle("Small-large copepod abundance") + -->
<!--     scale_x_continuous(expand = c(0.01, 0.01), limits = c(1998, 2018))+ -->
<!--       geom_hline(aes(yintercept = hline, -->
<!--                      group = Var), -->
<!--            size = hline.size, -->
<!--            alpha = hline.alpha, -->
<!--            linetype = hline.lty)+ -->
<!--   theme_ts() + -->
<!--   theme(strip.text=element_text(hjust=0, -->
<!--                                 face = "italic")) -->

<!-- pp_anom_plt <- pp_anom %>%  -->
<!--     ggplot(aes(x = Time, y = Value, group = Var)) + -->
<!--          annotate("rect", fill = shade.fill, alpha = shade.alpha, -->
<!--       xmin = x.shade.min , xmax = x.shade.max, -->
<!--       ymin = -Inf, ymax = Inf) + -->
<!--   geom_line() + -->
<!--   geom_point() + -->
<!--   guides(color = F) + -->
<!--   ylab("Anomaly ratio") + -->
<!--   xlab(element_blank())+ -->
<!--   ggtitle("Primary production anomaly ratio") + -->
<!--     scale_x_continuous(expand = c(0.01, 0.01), limits = c(1998, 2018))+ -->
<!--     scale_y_continuous(limits = c(0.8,1.2)) + -->
<!--       geom_hline(aes(yintercept = hline, -->
<!--                      group = Var), -->
<!--            size = hline.size, -->
<!--            alpha = hline.alpha, -->
<!--            linetype = hline.lty)+ -->
<!--   theme_ts() + -->
<!--   theme(strip.text=element_text(hjust=0, -->
<!--                                 face = "italic")) -->


<!-- sli_plt + pp_anom_plt + plot_layout(ncol = 1) & theme(plot.margin = margin(t = 0)) -->
<!-- ``` -->

#### Zooplankton Diversity

```{r zoo-diversity, fig.width = 8, fig.asp = .35, fig.cap="Zooplankton diversity in the Mid-Atlantic Bight."}
zoo_div <- ecodata::zoo_diversity %>% 
  dplyr::filter(EPU == epu_abbr)

zoo_div %>% 
  ggplot2::ggplot(aes(x = Time, y = Value, group = Var)) +
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  ecodata::geom_gls() +
  ggplot2::geom_line() +
  ggplot2::geom_point() +
  ggplot2::ylab("Shannon Diversity Index") +
  ggplot2::xlab(element_blank())+
  ggplot2::ggtitle("Zooplankton Diversity") +
  ggplot2::facet_wrap(Var~., ncol = 3) +
  ggplot2::scale_x_continuous(expand = c(0.01, 0.01))+
  ggplot2::geom_hline(aes(yintercept = mean(Value)),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty)+
  ecodata::theme_facet() +
  ggplot2::theme(strip.text=element_blank())
  




```

#### Calanus Stage

```{r calanus-stage,  fig.cap=""}
cal <- ecodata::CalanusStage %>% 
  dplyr::filter(EPU == "GB") %>% 
  filter(Var %in% c("c3", "c4", "c5", "adt"))

cal$Var <- factor(cal$Var, levels = c("c3", "c4", "c5", "adt"))
cal$season <- factor(cal$season, levels = c("Spring", "Summer", "Fall"))

cal %>% 
  ggplot2::ggplot(aes(x = Year, y = Value, color = Var, fill = Var)) +
    ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf)+
  ggplot2::geom_bar(stat = "identity")+
  ggplot2::facet_wrap(~season)+
  ggplot2::ylab("Calanus Stage (N/100m^3)") +
  ggplot2::xlab(element_blank())+
  ggplot2::ggtitle("MAB Calanus Stage Abundance") +
  ggplot2::theme(legend.position = "bottom", 
                 legend.title = element_blank())+
  ecodata::theme_facet()+
  scale_fill_manual(values = c("steelblue1","steelblue3", "coral1", "coral3"))+
  scale_color_manual(values = c("steelblue1","steelblue3", "coral1", "coral3"))

cal %>% 
  ggplot2::ggplot(aes(x = Year, y = Value, color = Var, fill = Var)) +
    ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf)+
  ggplot2::geom_bar(stat = "identity")+
  ggplot2::facet_wrap(~season, ncol = 1, scales = "free")+
  ggplot2::ylab("Calanus Stage (N/100m^3)") +
  ggplot2::xlab(element_blank())+
  ggplot2::ggtitle("MAB Calanus Stage Abundance") +
  ggplot2::theme(legend.position = "bottom", 
                 legend.title = element_blank())+
  ecodata::theme_facet()+
  scale_fill_manual(values = c("steelblue1","steelblue3", "coral1", "coral3"))+
  scale_color_manual(values = c("steelblue1","steelblue3", "coral1", "coral3"))

cal %>% 
  ggplot2::ggplot() +
    ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf)+
  ggplot2::geom_line(aes(x = Year, y = meanday))+
  ggplot2::geom_point(aes(x = Year, y = meanday))+
  #ecodata::geom_gls( aes(x = Year, y = meanday)) +
  ggplot2::facet_wrap(~season, ncol = 3, scales = "free")+
  ggplot2::ylab("Mean day of year") +
  ggplot2::xlab(element_blank())+
  ggplot2::ggtitle("MAB Calanus Stage Mean DOY") +
  #ggplot2::theme(legend.position = "bottom", 
  #               legend.title = element_blank())+
  ecodata::theme_facet()

cal %>% 
  ggplot2::ggplot() +
    ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf)+
  ggplot2::geom_line(aes(x = Year, y = ndays))+
  ggplot2::geom_point(aes(x = Year, y = ndays))+
  #ecodata::geom_gls( aes(x = Year, y = ndays)) +
  ggplot2::facet_wrap(~season, ncol = 3, scales = "free")+
  ggplot2::ylab("Number of sampling days") +
  ggplot2::xlab(element_blank())+
  ggplot2::ggtitle("MAB Number of sampling days") +
  #ggplot2::theme(legend.position = "bottom", 
  #               legend.title = element_blank())+
  ecodata::theme_facet()
```

<!-- #### OI abundance -->

<!-- ```{r MAB-oi-zoo, fig.width=8} -->
<!-- facet_names <- list( -->
<!--   'centropages spring'=expression(paste(italic("Centropages "), "spring")), -->
<!--   'centropages fall'=expression(paste(italic("Centropages "), "fall")), -->
<!--   'temora spring'=expression(paste(italic("Temora "), "spring")), -->
<!--   'temora fall' = expression(paste(italic("Temora "), "fall")), -->
<!--   'pseudocalanus spring'=expression(paste(italic("Pseudocalanus "), "spring")), -->
<!--   'pseudocalanus fall' = expression(paste(italic("Pseudocalanus "), "fall"))) -->

<!-- zoo_oi_mab <- ecodata::zoo_oi %>%  -->
<!--   filter(!str_detect(Var,"SD"), -->
<!--          EPU == "MAB") %>%  -->

<!--   mutate(Var = str_remove(Var, " zoo"), -->
<!--          Val2 = exp(Value)) %>%  -->
<!--       group_by(Var) %>%  -->
<!--   mutate(hline = mean(Val2, na.rm = T)) %>%  -->
<!--   separate(.,col = Var, into = c("Species","Season"), remove = F) %>%  -->
<!--   mutate(Season = factor(Season, levels = c("spring", "fall"))) -->


<!-- top <- zoo_oi_mab %>%   -->
<!--   filter(Species == "centropages") %>%  -->

<!-- ggplot(aes(x = Time, y = Val2, group = Var)) + -->
<!--   annotate("rect", fill = shade.fill, alpha = shade.alpha, -->
<!--       xmin = x.shade.min , xmax = x.shade.max, -->
<!--       ymin = 0, ymax = Inf) + -->
<!--   geom_hline(aes(yintercept = hline), -->
<!--      size = hline.size, -->
<!--      alpha = hline.alpha, -->
<!--      linetype = hline.lty)+ -->
<!--   geom_gls() + -->
<!--   geom_line()+ -->
<!--   geom_point()+ -->
<!--   ylab("") + -->
<!--   facet_wrap(Season ~ ., ncol = 2, scales='free_x',labeller = label) + -->
<!--   ggtitle("Zooplankton abundance (OI)") + -->
<!--   scale_x_continuous(expand = c(0.01, 0.01))+ -->
<!--   scale_y_continuous(trans = "log10")+ -->
<!--   theme_facet() + -->
<!--     theme(strip.text=element_text(hjust=0, -->
<!--                                 face = "italic"), -->
<!--           axis.title.x=element_blank(), -->
<!--         axis.text.x=element_blank(), -->
<!--         axis.ticks.x=element_blank()) -->

<!-- middle <- zoo_oi_mab %>%   -->
<!--   filter(Species == "pseudocalanus") %>%  -->
<!-- ggplot(aes(x = Time, y = Val2, group = Var)) + -->
<!--   annotate("rect", fill = shade.fill, alpha = shade.alpha, -->
<!--       xmin = x.shade.min , xmax = x.shade.max, -->
<!--       ymin = 0, ymax = Inf) + -->
<!--   geom_hline(aes(yintercept = hline), -->
<!--      size = hline.size, -->
<!--      alpha = hline.alpha, -->
<!--      linetype = hline.lty)+ -->
<!--   geom_gls() + -->
<!--   geom_line()+ -->
<!--   geom_point()+ -->
<!--   ylab(expression("Abundance num m"^-3*"")) + -->
<!--   facet_wrap(Season ~ ., ncol = 2, scales='free_x',labeller = label) + -->
<!--   scale_x_continuous(expand = c(0.01, 0.01))+ -->
<!--   scale_y_continuous(trans = "log10")+ -->
<!--   theme_facet() + -->
<!--     theme(strip.text=element_text(hjust=0, -->
<!--                                 face = "italic"), -->
<!--           axis.title.x=element_blank(), -->
<!--         axis.text.x=element_blank(), -->
<!--         axis.ticks.x=element_blank()) -->

<!-- bottom <- zoo_oi_mab %>%   -->
<!--   filter(Species == "temora") %>%  -->
<!-- ggplot(aes(x = Time, y = Val2, group = Var)) + -->
<!--   annotate("rect", fill = shade.fill, alpha = shade.alpha, -->
<!--       xmin = x.shade.min , xmax = x.shade.max, -->
<!--       ymin = 0, ymax = Inf) + -->
<!--   geom_hline(aes(yintercept = hline), -->
<!--      size = hline.size, -->
<!--      alpha = hline.alpha, -->
<!--      linetype = hline.lty)+ -->
<!--     geom_gls() + -->
<!--   geom_line()+ -->
<!--   geom_point()+ -->
<!--     ylab("") + -->
<!--   xlab(element_blank())+ -->
<!--   facet_wrap(Season ~ ., ncol = 2,labeller = label) + -->
<!--   scale_x_continuous(breaks = seq(1980,2010,10), -->
<!--                      expand = c(0.01, 0.01))+ -->

<!--   theme_facet() + -->
<!--     theme(strip.text=element_text(hjust=0, -->
<!--                                 face = "italic")) + -->
<!--    scale_y_log10() -->

<!-- top + middle + bottom + plot_layout(ncol = 1) & theme(plot.margin = margin(0,0,0,0,"cm")) -->

<!-- ``` -->

### Cold Pool Index

```{r cold_pool, eval = T, echo = F, fig.cap="Cold pool index." }

cp<- ecodata::cold_pool %>% 
  dplyr::group_by(Var) %>% 
  dplyr::mutate(hline = mean(Val, na.rm = T)) %>% 
  ggplot2::ggplot() + 
 #Highlight last ten years
  #ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
  #    xmin = x.shade.min , xmax = x.shade.max) +
  ecodata::geom_gls(aes(x = Time, y = Val),
             alpha = trend.alpha, size = trend.size) +
  ggplot2::geom_line(aes(x = Time, y = Val), size = lwd) +
  ggplot2::geom_point(aes(x = Time, y = Val), size = pcex) +
  ggplot2::geom_hline(aes(yintercept = hline),
     size = hline.size,
     alpha = hline.alpha,
     linetype = hline.lty)+
  ggplot2::ggtitle("Cold Pool Index")+
  ggplot2::facet_wrap(~Var, scales = "free")+
  ggplot2::ylab("Cold Pool") +
  ggplot2::xlab("")+
  ecodata::theme_ts()
cp
#plotly::ggplotly(cp) 
```


```{r cold_pool_map, eval = T, echo = F, fig.cap="Map of cold pool area. Time series of cold pool spatial extent FROM 1993-2018. Black = 2018 (Last year in time series), Red = 2012 Minimum area, Blue = 2005 Maximum area" }
cpsf26<- ecodata::cold_pool_sf %>% 
  mutate(Time = c(1:26)) %>% 
  filter(Time == 26)
cpsf<- ecodata::cold_pool_sf %>% 
  mutate(Time = c(1:26)) %>% 
  filter(!Time == 26)
cpmin <- ecodata::cold_pool_sf %>% 
  mutate(Time = c(1:26)) %>% 
  filter(Time == 20)
cpmax <- ecodata::cold_pool_sf %>% 
  mutate(Time = c(1:26)) %>% 
  filter(Time == 13)

#Map line parameters
map.lwd <- 0.4

# Set lat/lon window for maps
xmin = -78
xmax = -69
ymin = 35.5
ymax = 43
xlims <- c(xmin, xmax)
ylims <- c(ymin, ymax)

cp_map <- 
  ggplot2::ggplot() +
  #ggplot2::geom_tile(data =hw, aes(x = Longitude, y = Latitude,fill = Value)) +
  ggplot2::geom_sf(data = ecodata::coast, size = map.lwd) +
  ggplot2::geom_sf(data = cpsf, alpha = 0.1)  +
  ggplot2::geom_sf(data = cpsf26, fill = "transparent", color = "black", size = 1)+
   ggplot2::geom_sf(data = cpmax, fill = "transparent", color = "red", size = 0.5)+
  ggplot2::geom_sf(data = cpmin, fill = "transparent", color = "blue", size = 0.5)+
  ggplot2::coord_sf(crs = crs, xlim = xlims, ylim = ylims) +
  #ggplot2::scale_fill_gradient2(name = "Temp.\nAnomaly (C)",
  #                     low = scales::muted("blue"),
  #                     mid = "white",
  #                     high = scales::muted("red"),
  #                     limits = c(-4,4)) +
  
  #facet_wrap(Season~.) +
  ecodata::theme_map() +
  ggplot2::ggtitle("Cold Pool Area") +
  ggplot2::xlab("Longitude") +
  ggplot2::ylab("Latitude") +
  ggplot2::theme(panel.border = element_rect(colour = "black", fill=NA, size=0.75),
        legend.key = element_blank(),
        axis.title = element_text(size = 11),
        strip.background = element_blank(),
        strip.text=element_text(hjust=0),
        axis.text = element_text(size = 8),
        axis.title.y = element_text(angle = 90))


annotation_custom2 <- function (grob, xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf) 
{
  layer( stat = StatIdentity, position = PositionIdentity, 
        geom = ggplot2:::GeomCustomAnn,
        inherit.aes = TRUE, params = list(grob = grob, 
                                          xmin = xmin, xmax = xmax, 
                                          ymin = ymin, ymax = ymax))
}

area<- ecodata::cold_pool_sf %>%
  mutate(Time = c(1993:2018)) 
area2<- data.frame(Area = st_area(area))%>% 
  mutate(Time = c(1993:2018)) %>% 
  separate(Area, c("Value", "Units"), sep = " ") %>%
  mutate(Value = as.numeric(Value), 
         hline = mean(Value)) 

area_ts <-  ggplot2::ggplotGrob(area2 %>% 
                                      ggplot2::ggplot() +   
                                      ggplot2::geom_line(aes(x = Time, y = Value), size = lwd) +
                                      ggplot2::geom_point(aes(x = Time, y = Value), size = pcex) +
                                      ggplot2::geom_hline(aes(yintercept = hline),
                                                          size = hline.size,
                                                          alpha = hline.alpha,
                                                          linetype = hline.lty)+
                                      ggplot2::scale_x_continuous(breaks = c(1995, 2000, 2005, 2010, 2015),
                                                                  expand = c(0.01, 0.01)) +
                                      ggplot2::ggtitle("")+
                                      ggplot2::ylab("Area (m^2)") +
                                      ggplot2::xlab("")+
                                      ecodata::theme_ts()+
                              ggplot2::theme(
                                   axis.text.y = element_text(size = 6),
                                   axis.text.x = element_text(size = 6),
                                    panel.background = element_rect(fill = "transparent"),
                                    plot.background = element_rect(fill = "transparent", color = NA),
                                    panel.grid.major = element_blank(),
                                    panel.grid.minor = element_blank(),
                                    legend.background = element_rect(fill = "transparent"),
                                    legend.box.background = element_rect(fill = "transparent"),
                                    legend.key = element_rect(fill = "transparent", colour = NA),
                                    axis.line = element_blank())#,
                                    #panel.border = element_blank())
)

cp_map +
  annotation_custom(grob = area_ts,  xmin=-78.5, xmax=-71.75,
                     ymin=40.95, ymax=43.75)
```





```{r cold_pool_map2, eval = T, echo = F, fig.cap="Map of cold pool area." }
cpsf26<- ecodata::cold_pool_sf %>% 
  mutate(Time = c(1993:2018)) %>% 
  filter(Time == 2018)
cpsf<- ecodata::cold_pool_sf %>% 
  mutate(Time = c(1993:2018)) %>% 
  filter(!Time == 2018)

#Map line parameters
map.lwd <- 0.4

# Set lat/lon window for maps
xmin = -80
xmax = -68
ymin = 35.5
ymax = 43
xlims <- c(xmin, xmax)
ylims <- c(ymin, ymax)

cp_map <- 
  ggplot2::ggplot() +
  #ggplot2::geom_tile(data =hw, aes(x = Longitude, y = Latitude,fill = Value)) +
  ggplot2::geom_sf(data = ecodata::coast, size = map.lwd) +
  ggplot2::geom_sf(data = cpsf, alpha = 0.1, color = "red", size = 1)  +
  ggplot2::geom_sf(data = cpsf26, fill = "transparent", color = "red", size = 1)+
  
  ggplot2::coord_sf(crs = crs, xlim = xlims, ylim = ylims) +
  #ggplot2::scale_fill_gradient2(name = "Temp.\nAnomaly (C)",
  #                     low = scales::muted("blue"),
  #                     mid = "white",
  #                     high = scales::muted("red"),
  #                     limits = c(-4,4)) +
  
  #facet_wrap(Season~.) +
  ecodata::theme_map() +
  ggplot2::facet_wrap(~Time)+
  ggplot2::ggtitle("Cold Pool Area") +
  ggplot2::xlab("Longitude") +
  ggplot2::ylab("Latitude") +
  ggplot2::theme(panel.border = element_rect(colour = "black", fill=NA, size=0.75),
        legend.key = element_blank(),
        axis.title = element_text(size = 11),
        axis.ticks = element_blank(),
        strip.background = element_blank(),
        strip.text=element_text(hjust=0),
        axis.text = element_blank(),
        axis.title.y = element_text(angle = 90))


cp_map 
```




### Marine Heat Wave

[notes here](https://docs.google.com/document/u/1/d/1ik6aAXY85DEgLmz4BaBwxtdEPq6e9xXo/edit?usp=drive_web&ouid=111390006230717850267&rtpof=true)

```{r heatwave-year, eval= T, echo = F, out.width = "80%", fig.cap="Marine heatwave events (red) in the Mid-Atlantic occuring in 2020."}
ecodata::heatwave_year %>% 
  filter(EPU == "MAB", 
         str_detect(t, "2020")) %>% 
  ggplot( aes(x = t, y = temp))+
  geom_flame(aes(y2 = thresh))+ 
  geom_line(aes(x = t, y = seas, color = "a"), size = 1)+
  geom_line(aes(x = t, y = thresh, color = "c"), size = 1)+
  geom_line(aes(x = t, y = temp, color = "b"))+
  scale_colour_manual(values = c("turquoise4", "sienna3", "black"),
                      labels = c("Climatology","Temperature", "Threshold"))+
  ylab("Temperature (C)")+
  xlab(element_blank())+
  scale_x_date(date_labels = "%b", breaks = "1 month")+
  theme_bw()+
  theme(legend.title = element_blank(),
        legend.position=c(0.2, 0.8))


```

```{r heatwave, fig.cap="Marine heatwave cumulative intesity (left) and maximum intensity (right) in the Mid-Atlantic Bight."}

cumu <- ecodata::heatwave %>% 
  dplyr::filter(Var == "cumulative intensity") %>% 
  dplyr::mutate(Var = dplyr::recode(Var, "cumulative intensity" = "Cumulative Intensity (degree C x days)"))

maxin <- ecodata::heatwave %>% 
  dplyr::filter(Var == "maximum intensity") %>% 
  dplyr::group_by(Time, EPU, Var, Units) %>% 
  dplyr::summarise(Value = max(Value)) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(Var = dplyr::recode(Var, "maximum intensity" = "Maximum Intensity (degree C)"))

hw<- cumu %>%
  rbind(maxin) %>% 
  dplyr::group_by(Var, EPU) %>% 
  dplyr::mutate(hline = mean(Value))

mab.hw<- hw %>% dplyr::filter(EPU == epu_abbr)
mab.hw %>% 
  ggplot2::ggplot() +
  ggplot2::geom_line(aes(x = Time, y = Value)) +
  ggplot2::geom_point(aes(x = Time, y = Value)) +
  ecodata::geom_gls(aes(x = Time, y = Value, group = Var)) +
  ggplot2::ylab("") +
  ggplot2::xlab(element_blank())+
  ggplot2::ggtitle("Mid-Atlantic Marine Heatwave Intesity") +
  ggplot2::scale_x_continuous(expand = c(0.01, 0.01))+
  ggplot2::geom_hline(aes(yintercept = hline),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty)+
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  ggplot2::facet_wrap(~Var, scales = "free")+
  ecodata::theme_ts()+
  ggplot2::theme(strip.text=element_text(hjust=0,
                                face = "italic"))

```

```{r heatwave-anom-gridded, fig.cap="Maximum intensity heatwave anomaly in the Mid-Atlantic Bight occuring on July 28, 2020."}
#EPU shapefile
mab_epu_sf <- ecodata::epu_sf %>% 
  dplyr::filter(EPU %in% c("MAB"))

#Map line parameters
map.lwd <- 0.4

# Set lat/lon window for maps
xmin = -81
xmax = -66
ymin = 35.5
ymax = 43
xlims <- c(xmin, xmax)
ylims <- c(ymin, ymax)
hw <- ecodata::heatwave_peak_date %>% 
  dplyr::filter(EPU == "MAB") %>% 
  dplyr::mutate(Value = replace(Value, Value > 4, 4))

mab_map <- 
    ggplot2::ggplot() +
  ggplot2::geom_tile(data =hw, aes(x = Longitude, y = Latitude,fill = Value)) +
  ggplot2::geom_sf(data = ecodata::coast, size = map.lwd) +
  ggplot2::geom_sf(data = mab_epu_sf, fill = "transparent", size = map.lwd) +
  ggplot2::scale_fill_gradientn(name = "Temp.\nAnomaly (C)", 
                                colours = c(scales::muted("blue"), "white",
                                            scales::muted("red"), "black"),
                                values = scales::rescale(c(-4,0,4,8)),
                                guide = "colorbar", limits=c(-4,8)) +
  
  # ggplot2::scale_fill_gradient2(name = "Temp Anomaly (C)",
  #                      low = scales::muted("blue"),
  #                      mid = "white",
  #                      midpoint = 0,
  #                      high = scales::muted("red"),
  #                      guide = "colourbar",
  #                      limits = c(-4,8)) +
  ggplot2::coord_sf(crs = crs, xlim = xlims, ylim = ylims) +
  #facet_wrap(Season~.) +
  ecodata::theme_map() +
  ggplot2::ggtitle("MAB heatwave anomaly (July 28, 2020)") +
  ggplot2::xlab("Longitude") +
  ggplot2::ylab("Latitude") +
  ggplot2::theme(panel.border = element_rect(colour = "black", fill=NA, size=0.75),
        legend.key = element_blank(),
        axis.title = element_text(size = 11),
        strip.background = element_blank(),
        strip.text=element_text(hjust=0),
        axis.text = element_text(size = 8))


mab_map 

```

### Habitat Vulnerability

[Habitat Table found here](https://noaa-edab.github.io/ecodata/Hab_table)

### Ocean Acidication

```{r mab-oa, fig.cap = " Seasonal glider-based pH observations on the Mid-Atlantic Bight shelf (New Jersey cross-shelf transect) in relation to Atlantic surfclam and Atlantic sea scallop habitats (modified from Wright-Fairbanks et al. 2020)."}

knitr::include_graphics(file.path(image.dir, "Seasonal pH on MAB shelf - Grace Saba.jpg"))

```


```{r mab-oa-glider, fig.cap = "Glider Transect."}

knitr::include_graphics(file.path(image.dir, "pH glider transect map - Grace Saba.jpg"))

```

## Shelfwide Indicators {.tabset .tabset-fade}

### Seasonal SST anomaly

```{r shelf-seasonal-sst-anomaly-gridded, fig.height=8, fig.cap="Seasonal sea surface temperature anomalies for 2020 over the Northeast US Shelf."}
# Set lat/lon window for maps
xmin = -77
xmax = -65
ymin = 36
ymax = 45
xlims <- c(xmin, xmax)
ylims <- c(ymin, ymax)
sst <- ecodata::seasonal_sst_anomaly_gridded 

sst$Season <- factor(sst$Season, levels = c("Winter",
                                            "Spring",
                                            "Summer",
                                            "Fall"))

sst<- sst %>% dplyr::mutate(Value = replace(Value, Value > 4, 4))
epu_sf <- ecodata::epu_sf[ecodata::epu_sf$EPU != "SS",]

ggplot2::ggplot() +
  ggplot2::geom_tile(data = sst, aes(x = Longitude, y = Latitude, fill = Value)) +
  ggplot2::geom_sf(data = ecodata::coast, size = map.lwd) +
  ggplot2::geom_sf(data = epu_sf, fill = "transparent", size = map.lwd) +
  ggplot2::scale_fill_gradient2(name = "Temp.\nAnomaly (C)",
                       low = scales::muted("blue"),
                       mid = "white",
                       high = scales::muted("red"),
                       limits = c(-4,4), 
                       labels = c("<-4", "-2", "0", "2", ">4")) +
  ggplot2::coord_sf(crs = crs, xlim = xlims, ylim = ylims) +
  ggplot2::facet_wrap(Season~.) +
  ecodata::theme_map() +
  ggplot2::ggtitle("SST anomaly (2020)") +
  ggplot2::xlab("Longitude") +
  ggplot2::ylab("Latitude") +
  ggplot2::theme(panel.border = element_rect(colour = "black", fill=NA, size=0.75),
        legend.key = element_blank(),
        axis.title = element_text(size = 11),
        strip.background = element_blank(),
        strip.text=element_text(hjust=0),
        axis.text = element_text(size = 8))
```

### Long-term SST

```{r long-term-sst, fig.cap="Average annual sea surface temperature (SST) over the Northeast US Shelf."}
lt_sst <- ecodata::long_term_sst %>% 
  dplyr::mutate(hline = mean(Value, na.rm = TRUE))

hline <- mean(lt_sst$Value)

lt_sst %>% 
  ggplot2::ggplot(aes(x = Time, y = Value, group = Var)) +
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  ecodata::geom_gls() +
  ggplot2::geom_line() +
  ggplot2::geom_point() +
  ggplot2::geom_hline(aes(yintercept = hline),
             size = hline.size,
             alpha = hline.alpha,
           linetype = hline.lty)+
  ggplot2::ylab("Temperature (C)") +
  ggplot2::xlab(element_blank())+
  ggplot2::ggtitle("Long-term SST") +
  ggplot2::scale_x_continuous(expand = c(0.01, 0.01), breaks = seq(1840,2010,10))+
  ecodata::theme_facet() +
  ggplot2::theme(strip.text=element_text(hjust=0,
                                face = "italic"))
```

### GSI


[Notes](https://docs.google.com/document/d/1SgZ9m4pal3ygKnUSYr4UwgOoMJeaKzpO/edit)

```{r gsi, fig.width = 5, fig.asp = 0.55, fig.cap="Index representing the north wall  of the Gulf Stream. Positive values represent a more northerly Gulf Stream position."}
# ecodata::gsi %>% 
#   dplyr::mutate(Year = floor(Time)) %>% 
#   dplyr::group_by(Year) %>% 
#   dplyr::summarise(Value = mean(Value)) %>% 
#   dplyr::mutate(hline = mean(Value)) %>% 
#   dplyr::rename(Time = Year) %>% 
#   ggplot2::ggplot(aes(x = Time, y = Value)) +
#   ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
#       xmin = x.shade.min , xmax = x.shade.max,
#       ymin = -Inf, ymax = Inf) +
#   ecodata::geom_gls() +
#   ggplot2::geom_line() +
#   ggplot2::geom_point() +
#   ggplot2::ylab("Gulf Stream position anomaly") +
#   ggplot2::xlab(element_blank())+
#   ggplot2::ggtitle("Gulf Stream Index") +
#   ggplot2::scale_x_continuous(expand = c(0.01, 0.01))+
#   ggplot2::geom_hline(aes(yintercept = hline),
#            size = hline.size,
#            alpha = hline.alpha,
#            linetype = hline.lty)+
#   ecodata::theme_ts() +
#   ggplot2::theme(strip.text=element_text(hjust=0,
#                                 face = "italic"))

gsi<- ecodata::gsi %>% 
  dplyr::mutate(Year = floor(Time)) %>%
  dplyr::group_by(Year) %>%
  dplyr::summarise(Value = mean(Value)) %>%
  dplyr::mutate(hline = mean(Value)) %>%
  dplyr::rename(Time = Year)

gsi_old<- ecodata::gsi_old %>% 
  dplyr::mutate(Year = floor(Time)) %>%
  dplyr::group_by(Year) %>%
  dplyr::summarise(Value = mean(Value)) %>%
  dplyr::mutate(hline = mean(Value)) %>%
  dplyr::rename(Time = Year)

ggplot2::ggplot() +
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  ecodata::geom_gls(aes(x = gsi$Time, y = gsi$Value)) +
  ggplot2::geom_line(aes(x = gsi$Time, y = gsi$Value)) +
  ggplot2::geom_point(aes(x = gsi$Time, y = gsi$Value)) +
  #ecodata::geom_gls(aes(x = gsi_old$Time, y = gsi_old$Value)) +
  #ggplot2::geom_line(aes(x = gsi_old$Time, y = gsi_old$Value), color ="red") +
  #ggplot2::geom_point(aes(x = gsi_old$Time, y = gsi_old$Value), color = "red") +
  ggplot2::ylab("Gulf Stream position anomaly") +
  ggplot2::xlab(element_blank())+
  ggplot2::ggtitle("Gulf Stream Index") +
  ggplot2::scale_x_continuous(expand = c(0.01, 0.01))+
  #ggplot2::geom_hline(aes(yintercept = hline),
  #         size = hline.size,
  #         alpha = hline.alpha,
  #         linetype = hline.lty)+
  ecodata::theme_ts() +
  ggplot2::theme(strip.text=element_text(hjust=0,
                                face = "italic"))
```

### Warm Core Rings


```{r wcr, fig.cap= "Warm core ring formation on the Northeast US Shelf."}
upper.line<-ecodata::wcr %>%
  dplyr::filter(Time>2000) %>% 
  dplyr::mutate(hline = c(mean(Value)))
lower.line<-ecodata::wcr%>%
  dplyr::filter(Time<2000) %>% 
  dplyr::mutate(hline = c(mean(Value)))
wcr<- upper.line %>% 
  rbind(lower.line)

wcr %>% 
  ggplot2::ggplot(aes(x = Time, y = Value))+
  ggplot2::geom_point()+
  ggplot2::geom_line()+
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  ggplot2::ylab("Warm Core Ring Births")+
  ggplot2::xlab(element_blank())+
  ggplot2::ggtitle("Warm Core Rings")+
  ecodata::theme_ts()+
  ggplot2::geom_segment(data = upper.line, aes(x = min(Time), y = hline, 
                                      xend = max(Time), yend = hline, color = "segment") )+
  ggplot2::geom_segment(data = lower.line, aes(x = min(Time), y = hline, 
                                    xend = max(Time), yend = hline, color = "segment") )+
  ggplot2::theme(legend.position = "none")
```



